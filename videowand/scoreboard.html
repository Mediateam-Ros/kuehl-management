<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spielstand</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: black;
            color: white;
        }

        #homeScore,
        #awayScore {
            font-size: 150px;
            position: fixed;
            top: 40%;
            transform: translate(-50%, -50%);
        }

        #homeScore {
            left: 38%;
        }

        #awayScore {
            left: 64%;
        }

        #third {
            font-size: 65px;
            position: fixed;
            top: 7%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .scoreboard {
            display: flex;
            flex-direction: row;
        }
    </style>
</head>

<body>
    <div class="scoreboard">
        <div id="homeScore">0</div>
        <div id="awayScore">0</div>
    </div>
    <div id="third"></div>

    <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-database-compat.js"></script>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        const supabaseUrl = 'https://uedocrmntzzxescgmpkw.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlZG9jcm1udHp6eGVzY2dtcGt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1NTc0NTUsImV4cCI6MjA2MzEzMzQ1NX0.6C6OmnYBouLHTtlOAVoq4JQM-5o9j9YvIadYoKP5DC0'

        const supabase = createClient(supabaseUrl, supabaseKey);;

        function formatPeriod(period) {
            switch (period) {
                case "1_drittel": return "1/3";
                case "2_drittel": return "2/3";
                case "3_drittel": return "3/3";
                case "overtime": return "OT";
                case "penalty": return "SO";
                case "1_pause":
                case "2_pause":
                case "endstand":
                    return "";
                default: return period || "";
            }
        }

        async function loadNextGame() {
            try {
                const heute = new Date()
                const heuteISO = heute.toISOString().split('T')[0]  // "2024-05-26"

                const { data: spiele, error: spieleError } = await supabase
                    .from('games')
                    .select('*')
                    .eq('home_team_id', 101)
                    .gte('date', heuteISO)  // heute oder später
                    .order('date', { ascending: true })
                    .limit(1)

                if (!spiele) {
                    document.getElementById("countdown").innerText = "Keine Spieldaten gefunden.";
                    return;
                }

                const nextGame = spiele[0];
                const nextGameDateTime = new Date(`${nextGame.date}T${nextGame.time}`);

                loadActiveGameData(nextGame.id)

                console.log(spiele)
            } catch (spieleError) {
                console.error('Fehler beim Laden der Spieldaten:', spieleError);
                document.getElementById("countdown").innerText = 'Fehler';
            }
        }

        async function loadActiveGameData(gameId) {
            try {
                // ✅ Scores holen
                const { data: scores, error } = await supabase
                    .from('scores')
                    .select('*')
                    .eq('game_id', gameId);

                if (error) {
                    console.error("Fehler beim Laden der Scores:", error);
                    return;
                }

                // ✅ Aktuelle Spielphase laden (nur 1 Eintrag wegen UNIQUE)
                const { data: periods, error: periodError } = await supabase
                    .from('periods')
                    .select('*')
                    .eq('game_id', gameId)
                    .order('timestamp', { ascending: false })
                    .limit(1);

                if (periodError) {
                    console.error("Fehler beim Laden der Periode:", periodError);
                }

                // ✅ Letzte Scores nach Timestamp sortieren
                const homeScores = scores.filter(s => s.team === 'home');
                const awayScores = scores.filter(s => s.team === 'away');

                homeScores.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                awayScores.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                const homeScore = homeScores.length > 0 ? homeScores[0].score : 0;
                const awayScore = awayScores.length > 0 ? awayScores[0].score : 0;

                // ✅ Anzeige aktualisieren
                document.getElementById('homeScore').innerText = homeScore;
                document.getElementById('awayScore').innerText = awayScore;

                const currentPeriod = periods?.[0]?.period_number || "";
                document.getElementById("third").innerText = formatPeriod(currentPeriod);

            } catch (error) {
                console.error("Fehler beim Laden der Spieldaten:", error);
            }
        }

        setInterval(loadNextGame, 1000);
        loadNextGame();
    </script>

</body>

</html>