<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spielstand</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: black;
            color: white;
        }

        #homeScore,
        #awayScore {
            font-size: 150px;
            position: fixed;
            top: 40%;
            transform: translate(-50%, -50%);
        }

        #homeScore {
            left: 38%;
        }

        #awayScore {
            left: 64%;
        }

        #third {
            font-size: 65px;
            position: fixed;
            top: 7%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .scoreboard {
            display: flex;
            flex-direction: row;
        }
    </style>
</head>

<body>
    <div class="scoreboard">
        <div id="homeScore">0</div>
        <div id="awayScore">0</div>
    </div>
    <div id="third"></div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        const supabaseUrl = 'https://uedocrmntzzxescgmpkw.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlZG9jcm1udHp6eGVzY2dtcGt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1NTc0NTUsImV4cCI6MjA2MzEzMzQ1NX0.6C6OmnYBouLHTtlOAVoq4JQM-5o9j9YvIadYoKP5DC0'

        const supabase = createClient(supabaseUrl, supabaseKey);

        let activeGameId = null;

        function formatPeriod(period) {
            switch (period) {
                case "1_drittel": return "1/3";
                case "2_drittel": return "2/3";
                case "3_drittel": return "3/3";
                case "overtime": return "OT";
                case "penalty": return "SO";
                case "1_pause":
                case "2_pause":
                    return "Pause";
                case "endstand": return "Endstand";
                default: return period || "";
            }
        }

        async function initGame() {
            try {
                const heute = new Date();
                const heuteISO = heute.toISOString().split('T')[0];

                const { data: spiele, error } = await supabase
                    .from('games')
                    .select('*')
                    .eq('home_team_id', 101)
                    .gte('date', heuteISO)
                    .order('date', { ascending: true })
                    .limit(1);

                if (error) {
                    console.error("Fehler beim Laden des Spiels:", error);
                    return;
                }

                if (!spiele || spiele.length === 0) {
                    document.getElementById("third").innerText = "Kein Spiel gefunden";
                    return;
                }

                const nextGame = spiele[0];
                activeGameId = nextGame.id;

                // Erste Daten laden
                updateGameData();

                // Realtime-Listener starten
                subscribeRealtime();
            } catch (err) {
                console.error("Fehler bei initGame:", err);
            }
        }

        async function updateGameData() {
            if (!activeGameId) return;

            try {
                // ✅ Scores holen
                const { data: scores, error: scoreError } = await supabase
                    .from('scores')
                    .select('*')
                    .eq('game_id', activeGameId);

                if (scoreError) {
                    console.error("Fehler beim Laden der Scores:", scoreError);
                    return;
                }

                // ✅ Perioden holen
                const { data: periods, error: periodError } = await supabase
                    .from('periods')
                    .select('*')
                    .eq('game_id', activeGameId)
                    .order('timestamp', { ascending: false })
                    .limit(1);

                if (periodError) {
                    console.error("Fehler beim Laden der Periode:", periodError);
                }

                // ✅ Scores sortieren & letzten Wert nehmen
                const homeScores = scores.filter(s => s.team === 'home');
                const awayScores = scores.filter(s => s.team === 'away');

                homeScores.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                awayScores.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                const homeScore = homeScores.length > 0 ? homeScores[0].score : 0;
                const awayScore = awayScores.length > 0 ? awayScores[0].score : 0;

                // ✅ Anzeige aktualisieren
                document.getElementById('homeScore').innerText = homeScore;
                document.getElementById('awayScore').innerText = awayScore;

                const currentPeriod = periods?.[0]?.period_number || "";
                document.getElementById("third").innerText = formatPeriod(currentPeriod);

            } catch (err) {
                console.error("Fehler bei updateGameData:", err);
            }
        }

        function subscribeRealtime() {
            if (!activeGameId) return;

            // Scores Realtime
            supabase.channel('scores_channel')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'scores', filter: `game_id=eq.${activeGameId}` },
                    payload => {
                        console.log("Score Update:", payload);
                        updateGameData();
                    }
                )
                .subscribe();

            // Periods Realtime
            supabase.channel('periods_channel')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'periods', filter: `game_id=eq.${activeGameId}` },
                    payload => {
                        console.log("Period Update:", payload);
                        updateGameData();
                    }
                )
                .subscribe();
        }

        // Start
        initGame();
    </script>

</body>
</html>
